---
title: 反思c++面向对象和虚函数

date: 2022-6-14 17:59:20

updated: 2022-6-14 17:59:20

tags:

- c++

categories:

- [编程语言, c++编程杂谈]

---

# 一.c++设计

实用当头，朴实为贵，简单好用才是王道

c++面向对象中，只有封装是必要的，继承和多态反而会增加软件复杂度，使用std::function和闭包取代虚函数，组合取代继承

c++有两种语义，值语义和对象语义，值语义就是数据抽象，允许拷贝，对象语义不允许拷贝。值语义生命期管理简单，根本不需要担心其生命期，但对象语义生命期管理有本质的困难，智能指针可以把对象语义转换成值语义，从而解决生命期管理问题

# 二.c++二进制兼容性

二进制兼容性是指，升级库文件，不必重新编译可执行文件，并且程序的功能不会被破坏

c++的虚函数虚函数的二进制兼容性太差，c++中调用虚函数不是通过名字，而是通过vptr偏移。如果以虚函数为接口，那么一经发布就不能修改，因为修改会破坏vptr偏移，从而破坏二进制兼容性。非虚成员函数更健壮，因为程序启动的时候，是通过名字将动态库和可执行文件链接在一起的

如果程序是以动态库发行的，需要考虑二进制兼容性，如果通过静态库发行，库更新后需要重新链接，更好的方法是发行源码，每次重新编译就可以

# 三.iostream

iostream是一个失败的设计，在stdio上投入精力比iostream更划算

通过流操作运算符可以设计出精巧的日志库，支持格式化也很简单
