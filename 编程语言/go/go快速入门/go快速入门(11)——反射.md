---
title: go快速入门(11)——反射

date: 2022-5-8 16:00:01

updated: 2022-5-8 16:00:01

tags:

- go语言

categories:

- [编程语言, go, go快速入门]

---

# 一.反射的意义

- 考虑如下情况，空接口固然可以接收所有值，但是有一个问题，如果每来一个新的类型，都写一次case，那这个函数永远写不完
  
  ```go
  func Sprint(x interface{}) {
      switch x := x.(type) {
          case string:
              //...
          case int:
              //...
          default:
              //...
      }
  }
  ```

- 反射可以解决这个问题，可以在运行的时候查看值类型，并直接操作值的布局

# 二.reflect.Type

- reflect.Type是一个拥有很多方法的接口，这些方法可以识别类型和透视类型的组成部分，比如结构体的各个字段或函数的各个参数

- reflect.TypeOf函数接收任何的interface{}参数，并返回reflect.Type类型
  
  ```go
  t := reflect.TypeOf(3)
  fmt.Println(t) // int
  fmt.Println(t.String()) // int
  ```

# 三.reflect.Value

- reflect.Value是一个结构体，可以包含任意类型的值

- reflect.ValueOf函数接收任何类型的interface{}函数，并将接口的动态值以reflect.Value的形式返回
  
  ```go
  v := reflect.ValueOf(3)
  fmt.Println(v) // 3
  fmt.Println(v.String() // <int Value>
  ```

- note：reflect.Value和interface{}都可以包含任意类型的值，二者的区别是interface隐藏了值的信息，除非我们把类型断言出来，否则能做的事情有限；reflect.Value有很多方法去分析包含的值，而且不用知道其类型

# 四.结构体字段标签

- go允许使用结构体`字段标签`来修改go结构值的json编码方式，这个功能就是依靠反射实现的，反射可以获得结构体的字段标签，以此来进行编解码
  
  ```go
  package main
  
  import (
      "encoding/json"
      "fmt"
      "log"
  )
  
  type Movie struct {
      Title  string
      Year   int  `json:"released"`
      Color  bool `json:"color,omitempty"`
      Actors []string
  }
  
  var movies = []Movie{
      {Title: "Casablanca", Year: 1942, Color: false,
          Actors: []string{"Humphrey Bogart", "Ingrid Bergman"}},
      {Title: "Cool Hand Luke", Year: 1967, Color: true,
          Actors: []string{"Paul Newman"}},
      {Title: "Bullitt", Year: 1968, Color: true,
          Actors: []string{"Steve McQueen", "Jacqueline Bisset"}},
  }
  
  func main() {
      data, err := json.Marshal(movies)
      if err != nil {
          log.Fatalf("JSON marshaling failed: %s", err)
      }
      fmt.Printf("%s\n", data)
  }
  
  //output
  [{"Title":"Casablanca","released":1942,"Actors":["Humphrey Bogart","Ingrid Bergman"]},
  {"Title":"Cool Hand Luke","released":1967,"color":true,"Actors":["Paul Newman"]},
  {"Title":"Bullitt","released":1968,"color":true,"Actors":["Steve McQueen","Jacqueline Bisset"]}]
  ```
